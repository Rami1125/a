<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול הזמנות - ח.סבן</title>
    <link rel="icon" href="https://i.postimg.cc/2SbDgD1B/1.png">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      /* Your existing CSS here */
      /* NEW STYLE for notification button */
      .task-actions button.notify-btn {
          background-color: var(--accent);
      }
    </style>
</head>
<body>
    <!-- Your existing HTML content here -->
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // Your Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDy3k1AoEKeuCKjmFxefn9fapeqv2Le1_w",
          authDomain: "hsaban94-cc777.firebaseapp.com",
          databaseURL: "https://hsaban94-cc777.firebaseio.com",
          projectId: "hsaban94-cc777",
          storageBucket: "hsaban94-cc777.firebasestorage.app",
          messagingSenderId: "299206369469",
          appId: "1:299206369469:web:6e8674eb787e52fa9457d4",
          measurementId: "G-105YLDL68F"
        };
    
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        console.log("Firebase for Admin Initialized Successfully!");

        // ... your existing dom and state variables
        let state = { tasks: [], templates: [] };

        // ===== UPDATED REAL-TIME LISTENER =====
        function listenToNewRequests() {
            // Listen for requests added in the last 24 hours for relevance
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);
            db.collection("requests").where("Timestamp", ">", yesterday)
              .onSnapshot(snapshot => {
                let hasNew = false;
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        console.log("Real-time request received:", change.doc.data());
                        hasNew = true;
                    }
                });
                // If a new request came in, refresh the list to show it at the top
                if (hasNew) {
                  showToast("בקשה חדשה התקבלה!");
                  fetchTasks();
                }
              });
        }
        
        // ===== NEW FUNCTION TO SEND NOTIFICATION =====
        async function sendClientNotification(taskId) {
            const task = state.tasks.find(t => t.Timestamp === taskId);
            if (!task) return;

            const clientId = task['מספר לקוח'];
            const title = 'עדכון לגבי בקשתך';
            const message = `התקבל עדכון בנוגע לבקשתך מסוג "${task['סוג הבקשה']}".`;

            showToast(`שולח התראה ללקוח ${task['שם לקוח']}...`);
            try {
                const response = await apiPost({ 
                    action: 'sendNotificationToClient', 
                    clientId: clientId, 
                    title: title, 
                    message: message 
                });
                if (response.success) {
                    showToast('התראה נשלחה בהצלחה!', 'success');
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                console.error("Failed to send notification:", error);
                showToast('שגיאה בשליחת התראה.', 'error');
            }
        }
        
        function renderTasks() {
            // ... your existing render logic ...
            // INSIDE your map function, where you build the HTML for each card,
            // add the new button inside the .task-actions div:
            
            /*
            Example of where to add the button in your existing renderTasks:
            <div class="task-actions">
                <button data-action="share-whatsapp" class="whatsapp-btn">
                    <svg ...>...</svg>
                </button>
                <button data-action="send-notification" class="notify-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path></svg>
                </button>
            </div>
            */
        }
        
        function setupEventListeners() {
            document.body.addEventListener('click', e => {
                const actionElement = e.target.closest('[data-action]');
                // ... existing listener logic
                
                const action = actionElement.dataset.action;
                const taskCard = actionElement.closest('.task-card');
                const taskId = taskCard ? taskCard.dataset.taskId : null;

                switch (action) {
                    case 'share-whatsapp':
                        openWhatsAppModal(taskId);
                        break;
                    case 'toggle-done':
                        toggleTaskStatus(taskId);
                        break;
                    // --- NEW CASE for sending notifications ---
                    case 'send-notification':
                        sendClientNotification(taskId);
                        break;
                }
            });
        }
        
        async function initAdminDashboard() {
            await fetchTasks();
            setupEventListeners();
            listenToNewRequests(); // Activate real-time listener
        }

        // ... all your other functions (apiPost, showToast, etc.)
        
        initAdminDashboard();
    });
    </script>
</body>
</html>

